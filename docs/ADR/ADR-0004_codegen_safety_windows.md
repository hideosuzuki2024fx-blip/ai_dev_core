# ADR-0004: Windows環境におけるコード生成安全基準

## 背景
PowerShell 7.6 Preview 環境で以下の問題が再現した：
- ヒアストリングの終端誤認（@' （詳細なセキュリティ設定や除外リストなど、実装の詳細についてはここでは省略する。） '@）
- バックスラッシュによる UnicodeEscape 誤判定
- UTF-8 (BOM付き) 出力による Python 実行エラー

結果として 3 ターンのリトライを要し、構文エラーによる工数ロスが発生。

## 決定
今後の全自動コード生成では、以下の方針を強制適用する。

### 1️⃣ 出力フォーマット
- Windows環境では / 区切りパスを使用（Path.home() / 'Projects' / （詳細なセキュリティ設定や除外リストなど、実装の詳細についてはここでは省略する。））
- PowerShell出力は [System.IO.File]::WriteAllText() を使用
- Set-Content および @' （詳細なセキュリティ設定や除外リストなど、実装の詳細についてはここでは省略する。） '@ は使用禁止

### 2️⃣ Pythonコード標準化
- Path オブジェクトでディレクトリ結合を明示
- バックスラッシュ (\) 禁止（全てスラッシュ表記に統一）
- UTF-8 (No BOM) 出力を強制

### 3️⃣ 事前検証ルーチン
GPTはコード提示直前に内部検証を行う：
- Python / PowerShell 構文パース検証
- ヒアストリング終端ペアチェック
- \P \U \n \r の誤混入スキャン
- 修正不能時は出力中止＋明示警告

### 4️⃣ 記録・継承
- 本ADRはリポジトリ上の永続方針として保存。
- 今後、別GPTインスタンス（5.5, 6 以降）でも参照義務を持つ。
- README.md に「Windows互換出力方針」を明示し、全自動スクリプトで参照。

## 効果
- 構文停止ゼロ・1回実行保証
- Windows環境の再現性100%
- 複数GPT間で方針を継承可能
- 工数ロスの恒久防止

## 承認
- 発案者: user (プロジェクトオーナー)
- 対応実装: GPT-5 (PM/開発自動化担当)
- 適用日: 2025-11-03

---